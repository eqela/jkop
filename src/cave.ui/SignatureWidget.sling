
/*
 * This file is part of Jkop
 * Copyright (c) 2016-2017 Job and Esther Technologies, Inc.
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */

class is CanvasWidget imports cave imports cave.ui:

IFDEF("target_android")
{
	lang "java" {{{
		private android.graphics.Path path = new android.graphics.Path();
		private android.graphics.Paint paint = new android.graphics.Paint(android.graphics.Paint.ANTI_ALIAS_FLAG);
		private float lastTouchX;
		private float lastTouchY;
		private final android.graphics.RectF dirtyRect = new android.graphics.RectF();
	}}}

	func onTouchEvent(mevt as !"android.view.MotionEvent") as bool
	{
		lang "java" {{{
			float eventX = mevt.getX();
			float eventY = mevt.getY();
			if (mevt.getAction() == mevt.ACTION_DOWN) {
				path.moveTo(eventX, eventY);
				lastTouchX = eventX;
				lastTouchY = eventY;
				return true;
			}
			else if (mevt.getAction() == mevt.ACTION_MOVE) {
				float dx = Math.abs(lastTouchX - mevt.getX());
				float dy = Math.abs(lastTouchY - mevt.getY());
				if (dx >= 1 || dy >= 1) {
					path.quadTo(lastTouchX, lastTouchY, (mevt.getX() + lastTouchX)/2, (mevt.getY() + lastTouchY)/2);
				}
			}
			else if (mevt.getAction() == mevt.ACTION_UP) {
				resetDirtyRect(eventX, eventY);
				int historySize = mevt.getHistorySize();
				for (int i = 0; i < historySize ; i++) {
					float historicalX = mevt.getHistoricalX(i);
					float historicalY = mevt.getHistoricalY(i);
					expandDirtyRect(historicalX, historicalY);
					path.lineTo(historicalX, historicalY);
				}
				path.lineTo(eventX, eventY);
			}
			invalidate(
				(int) (dirtyRect.left - strokeWidth / 2),
				(int) (dirtyRect.top - strokeWidth / 2),
				(int) (dirtyRect.right + strokeWidth / 2),
				(int) (dirtyRect.bottom + strokeWidth / 2)
			);
			lastTouchX = eventX;
			lastTouchY = eventY;
		}}}
		return true
	}

	func onDraw(canvas as !"android.graphics.Canvas")
	{
		lang "java" {{{
			super.onDraw(canvas);
			canvas.drawPath(path, paint);
		}}}
	}

	lang "java" {{{
		private void expandDirtyRect(float historicalX, float historicalY) {
			if (historicalX < dirtyRect.left) {
				dirtyRect.left = historicalX;
			}
			else if (historicalX > dirtyRect.right) {
				dirtyRect.right = historicalX;
			}
			if (historicalY < dirtyRect.top) {
				dirtyRect.top = historicalY;
			}
			else if (historicalY > dirtyRect.bottom) {
				dirtyRect.bottom = historicalY;
			}
		}

		private void resetDirtyRect(float eventX, float eventY) {
			dirtyRect.left = Math.min(lastTouchX, eventX);
			dirtyRect.right = Math.max(lastTouchX, eventX);
			dirtyRect.top = Math.min(lastTouchY, eventY);
			dirtyRect.bottom = Math.max(lastTouchY, eventY);
		}
	}}}
}

var strokeColor as Color
var strokeWidth as float

ctor(ctx as GuiApplicationContext)
{
	base(ctx)
	strokeColor = Color.black()
	strokeWidth = 5.0 as float
	IFDEF("target_android") {
		lang "java" {{{
			paint.setAntiAlias(true);
			paint.setColor(android.graphics.Color.BLACK);
			paint.setStyle(android.graphics.Paint.Style.STROKE);
			paint.setStrokeJoin(android.graphics.Paint.Join.ROUND);
			paint.setStrokeWidth(strokeWidth);
		}}}
	}
}

func setStrokeColor(color as Color)
{
	strokeColor = color
	IFDEF("target_android") {
		if (strokeColor == null) {
			lang "java" {{{
				paint.setColor(0);
			}}}
		}
		else {
			lang "java" {{{
				paint.setColor(strokeColor.toARGBInt32());
			}}}
		}
	}
	ELSE {
		ERROR("Not implemented.")
	}
}

func setStrokeWidth(width as float)
{
	strokeWidth = width
	IFDEF("target_android") {
		lang "java" {{{
			paint.setStrokeWidth(strokeWidth);
		}}}
	}
	ELSE {
		ERROR("Not implemented.")
	}
}

func clear
{
	IFDEF("target_android") {
		lang "java" {{{
			path.reset();
			invalidate();
		}}}
	}
	ELSE {
		ERROR("Not implemented.")
	}
}

func getSignatureAsImage as Image
{
	IFDEF("target_android") {
		var byteArray as buffer
		lang "java" {{{
			android.graphics.Bitmap bitmap = android.graphics.Bitmap.createBitmap(this.getWidth(), this.getHeight(), android.graphics.Bitmap.Config.ARGB_8888);
			android.graphics.Canvas canvas = new android.graphics.Canvas(bitmap);
			this.draw(canvas);
			java.io.ByteArrayOutputStream bufferStream = new java.io.ByteArrayOutputStream();
			bitmap.compress(android.graphics.Bitmap.CompressFormat.PNG, 100, bufferStream);
			byteArray = bufferStream.toByteArray();
		}}}
		return ImageForAndroid.forBuffer(byteArray)
	}
	ELSE {
		ERROR("Not implemented.")
		return (null)
	}
}
